cmd_venv() {
    if [[ $# -eq 0 ]]; then
        echo "Error: No command specified"
        echo "Use 'venv help' for usage information"
        return 1
    fi

    local app_path=""
    local install_dev=false
    local venv_name=".venv"

    local command="$1"
    shift

    case $command in
      deps)
          # Parse --dev flag
          while [[ $# -gt 0 ]]; do
              case $1 in
                  --dev)
                      install_dev=true
                      shift
                      ;;
                  *)
                      echo "Error: Unknown flag '$1' for 'deps' command"
                      echo "Valid flags: --dev"
                      return 1
                      ;;
              esac
          done
          ;;
        load | init | run)
            # Optional argument (venv name or app path)
            if [[ -n "$1" ]] && [[ ! "$1" =~ ^-- ]]; then
                if [[ "$command" == "run" ]]; then
                    app_path="$1"
                else
                    venv_name="$1"
                fi
                shift
            fi
            ;;
        check | test | help)
            # No additional arguments needed
            ;;
        *)
            echo "Error: Unknown command '$command'"
            echo "Use 'venv help' for usage information"
            return 1
            ;;
    esac

    case $command in
        load)
            if [[ -f "$venv_name/bin/activate" ]]; then
                source "$venv_name/bin/activate"
                echo "✓ Activated virtual environment: $venv_name"
            else
                echo "✗ Virtual environment not found: $venv_name/bin/activate"
                echo "Tip: Use 'venv init $venv_name' to create it"
                return 1
            fi
            ;;
        init)
            if [[ -d "$venv_name" ]]; then
                echo "✗ Virtual environment already exists: $venv_name"
                return 1
            fi
            echo "Creating virtual environment: $venv_name"
            python3 -m venv "$venv_name"
            if [[ $? -eq 0 ]]; then
                echo "✓ Virtual environment created: $venv_name"
                echo "Tip: Use 'venv load $venv_name' to activate it"
            else
                echo "✗ Failed to create virtual environment"
                return 1
            fi
            ;;
        deps)
            if [[ -z "$VIRTUAL_ENV" ]]; then
                echo "✗ No virtual environment is active"
                echo "Tip: Use 'venv load' to activate one first"
                return 1
            fi

            if [[ ! -f "pyproject.toml" ]]; then
                echo "✗ pyproject.toml not found in current directory"
                return 1
            fi

            local installer_cmd=()

            if command -v uv &> /dev/null; then
                installer_cmd=(uv pip)
                echo "Using uv (fast installer)"
            elif command -v pip &> /dev/null; then
                installer_cmd=(pip)
                echo "Using pip (uv not found - install with 'pip install uv' for faster installs)"
            else
                echo "✗ Neither uv nor pip found"
                return 1
            fi

            if [[ "$install_dev" == true ]]; then
                echo "Installing project with dev dependencies..."
                "${installer_cmd[@]}" install -e ".[dev]"
            else
                echo "Installing project dependencies..."
                "${installer_cmd[@]}" install -e .
            fi

            if [[ $? -eq 0 ]]; then
                echo "✓ Dependencies installed successfully"
                if [[ "$install_dev" == true ]]; then
                    echo "  Installed: production + dev dependencies"
                else
                    echo "  Installed: production dependencies only"
                    echo "  Tip: Use 'venv deps --dev' to include dev dependencies"
                fi
            else
                echo "✗ Failed to install dependencies"
                return 1
            fi
            ;;
        check)
            if [[ -n "$VIRTUAL_ENV" ]]; then
                echo "✓ Virtual environment is active"
                echo "  Path: $VIRTUAL_ENV"
                echo "  Python: $(which python)"
                echo "  Version: $(python --version)"
            else
                echo "✗ No virtual environment is currently active"
            fi
            ;;
        run)
            if [[ -z "$VIRTUAL_ENV" ]]; then
                echo "✗ No virtual environment is active"
                echo "Tip: Use 'venv load' to activate one first"
                return 1
            fi

            if ! command -v uvicorn &> /dev/null; then
                echo "✗ uvicorn not found"
                echo "Tip: Install with 'venv deps --dev'"
                return 1
            fi

            # Auto-detect main.py location if not specified via command line
            if [[ -z "$app_path" ]]; then
                local detected_path=""

                # Use find to locate main.py, excluding common non-code directories
                # Search up to 3 levels deep, prioritize shallower files
                detected_path=$(find . -maxdepth 3 -name "main.py" \
                    -not -path "*/.venv/*" \
                    -not -path "*/venv/*" \
                    -not -path "*/__pycache__/*" \
                    -not -path "*/node_modules/*" \
                    -not -path "*/.git/*" \
                    -not -path "*/build/*" \
                    -not -path "*/dist/*" \
                    2>/dev/null | \
                    awk '{print length, $0}' | \
                    sort -n | \
                    head -1 | \
                    cut -d' ' -f2-)

                # Remove leading ./ if present
                detected_path="${detected_path#./}"

                if [[ -n "$detected_path" ]]; then
                    # Convert file path to Python module path
                    # Remove .py extension and convert / to .
                    app_path="${detected_path%.py}"
                    app_path="${app_path//\//.}:app"
                    echo "✓ Auto-detected: $detected_path → $app_path"
                else
                    # Fallback to default
                    app_path="main:app"
                    echo "⚠ No main.py found (searched up to 3 levels deep), using default: $app_path"
                fi
            else
                echo "✓ Using specified path: $app_path"
            fi

            echo "Starting uvicorn server: $app_path"
            uvicorn "$app_path" --host 0.0.0.0 --port 8000 --reload
            ;;
        test)
            if [[ -z "$VIRTUAL_ENV" ]]; then
                echo "✗ No virtual environment is active"
                echo "Tip: Use 'venv load' to activate one first"
                return 1
            fi

            if ! command -v pytest &> /dev/null; then
                echo "✗ pytest not found"
                echo "Tip: Install with 'venv deps --dev'"
                return 1
            fi

            echo "Running all tests..."
            if [[ -d "tests" ]]; then
                python -m pytest tests/ -v
            else
                python -m pytest -v
            fi
            ;;
        help)
            cat << 'EOF'
venv - Virtual Environment Management

Usage:
  venv <command> [arguments] [flags]

Commands:
  load [name]           Activate virtual environment (default: .venv)
  init [name]           Create new virtual environment (default: .venv)
  deps [--dev]          Install dependencies from pyproject.toml
  check                 Show currently active venv info
  run [app:path]        Run uvicorn server (auto-detects main.py location)
  test                  Run all tests with pytest
  help                  Show this help message

Flags:
  --dev                 Include dev dependencies (use with 'deps' command)

Examples:
  venv load             # Activate .venv
  venv load myenv       # Activate myenv
  venv init             # Create .venv
  venv init myenv       # Create myenv
  venv deps             # Install production dependencies
  venv deps --dev       # Install production + dev dependencies
  venv check            # Check active venv
  venv run              # Auto-detect and run (searches: main.py, src/main.py, app/main.py, etc.)
  venv run src.main:app # Override with custom path
  venv test             # Run all tests

Auto-detection for 'venv run':
  Automatically searches for main.py up to 3 levels deep in your project,
  excluding common non-code directories (.venv, __pycache__, node_modules, etc.)

  Prioritizes shallower paths (e.g., src/main.py over src/api/v1/main.py)

  Automatically converts file path to Python module path:
    src/main.py → src.main:app
    app/server/main.py → app.server.main:app

Typical workflow:
  venv init             # Create .venv
  venv load             # Activate .venv
  venv deps --dev       # Install all dependencies (uses uv if available)
  venv run              # Auto-detect and run the server
EOF
            ;;
    esac
}
